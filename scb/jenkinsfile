pipeline {
    agent Master  // Master에서 빌드 실행

    environment {
        APP_NAME = 'bumpy103/schat-backend-app'
        DOCKER_IMAGE = "bumpy103/schat-backend-app:latest"
        DEPLOY_NODE = 'product-node'  // 실행 서버 Node label
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm  // 현재 브랜치 자동 체크아웃
            }
        }

        stage('Build & Test') {
            steps {
                echo '빌드 및 테스트 중...'
                sh './gradlew clean build test'  // Gradle 프로젝트 예시
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'Docker 이미지 빌드 중...'
                sh "docker build -t ${DOCKER_IMAGE} ."
            }
        }

        stage('Deploy to Execution Node') {
            agent { label "${DEPLOY_NODE}" }  // 배포 전용 Node에서 실행
            steps {
                echo '실행 서버에 배포 중...'
                sh "docker stop ${APP_NAME} || true"
                sh "docker rm ${APP_NAME} || true"
                sh "docker run -d --name ${APP_NAME} -p 8080:8080 ${DOCKER_IMAGE}"
            }
        }
    }

    post {
        success {
            echo 'CI/CD 파이프라인 성공!'
        }
        failure {
            echo 'CI/CD 파이프라인 실패!'
        }
    }
}